// Connor S. Murray, PhD
// Started: 12.17.2025
// A nextflow pipeline for simulating HiFi reads and detecting viral integrations

// Paramters for pipeline
params {
    help = false

    // Input genomes
    host_genome = "/work/c0murr09/human_genome/GRCh38.primary_assembly.genome.fa"
    viral_genome = "/work/c0murr09/viral_genome/GCA_003190765.1_ASM319076v1_genomic.fna"
    //viral_genomes = "/work/c0murr09/viral_genome/hiv_genome_panal/*fasta"
    viral_genomes = "/work/c0murr09/viral_genome/test_hiv_genome_panal/*fasta"

    // Patient samples (set to skip simulation)
    patient_dir = "/work/c0murr09/raw_data/stc1621/1621_pool4/hifi_reads/"  // Directory containing patient BAM/FASTQ files, set to skip simulation
    patient_bam = null  // Legacy
    patient_fastq = null 

    // Competetive mapping 
    min_mapq = 20
    max_iterations = 5
    convergence_threshold = 0.01
    trim_begin = 0
    trim_end = 0
    
    // Quality filtering
    min_mapq = 0
    remove_secondary = true
    remove_supplementary = true

    // Integration parameters (If running simulation)
    n_integrations = 10
    target_chroms = null
    seed = null

    // Simulation (pbsim3) parameters
    depth = 30
    length_mean = 15000
    accuracy_mean = 0.99
    pbsim_model = "/opt/pbsim3/data/QSHMM-RSII.model" // This is within the apptainer image

    // fastp parameters
    fastp_qual = 15  // Minimum quality score
    fastp_min_length = 1000  // Minimum read length after trimming
    fastp_adapters = null  // Path to adapter FASTA file (null = auto-detect)

    // Picard parameters
    picard_max_records = 500000  // Max records in RAM for MarkDuplicates

    // Output
    outdir = './output'

    // SLURM
    partition = 'cpu384g'
    threads = 4
    memory = '15 GB'

    // Container
    container = '/work/c0murr09/viral_int2.sif'
}

// Define profiles for slurm execution environment
profiles {
    slurm {
        process {
            executor = 'slurm' // Use SLURM as the executor
            clusterOptions = "--partition=${params.partition}" // SLURM partition, account
            cpus = "${params.threads}" // Number of threads per job
            memory = "${params.memory}" // Memory per job
            errorStrategy = 'ignore'
            queueSize = 20 // Specific to UofL limit - you should change this to higher limits on other HPCs
            submitRateLimit = '15 sec'  // Throttle job submission to avoid overwhelming scheduler
            pollInterval = '30 sec'  // Check job status every 30 seconds
        }

            // Process-specific resources
            withName: 'SIMULATE_READS' {
                cpus = 16
                memory = '10 GB'
                time = '4h'
            }
            
            withName: 'INITIAL_VIRAL_MAPPING|ITERATIVE_VIRAL_MAPPING' {
                cpus = 8
                memory = '10 GB'
                time = '2h'
            }
            
            withName: 'MAP_FLANKS_TO_HOST|CONFIRM_HOST_ALIGNMENTS' {
                cpus = 8
                memory = '15 GB'
                time = '2h'
            }
            
            withName: 'GENERATE_INTEGRATIONS' {
                cpus = 4
                memory = '10 GB'
                time = '2h'
            }
            
            withName: 'COMBINE_RESULTS' {
                cpus = 2
                memory = '5 GB'
                time = '1h'
            }
    }
}

// Manifest
manifest {
    name = 'HIV-SMRTCap-Pipeline'
    author = 'Connor S. Murray, PhD'
    description = 'HIV integration detection pipeline using SMRTCap methodology with PacBio HiFi sequencing'
    version = '2.0.0'
    nextflowVersion = '>=23.04.0'
    mainScript = 'viral_integration_smrt.nf'
}

report {
    enabled = true
    file = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

// Container parameters (keep at end of config - nf can be particular...)
apptainer.enabled = true
apptainer.autoMounts = true
apptainer.pullTimeout  = '20m'